apiVersion: v1
kind: ConfigMap
metadata:
  name: multi-cluster-alert-rules
  namespace: observability-alertmanager
data:
  multi-cluster-infrastructure.yaml: |
    groups:
      - name: multi-cluster-infrastructure
        rules:
          # Alert when any cluster in any environment is down
          - alert: ClusterDown
            expr: up{job="kubernetes-apiservers"} == 0
            for: 5m
            labels:
              severity: critical
              environment: "{{ $labels.environment }}"
              cluster: "{{ $labels.cluster }}"
            annotations:
              summary: "Cluster {{ $labels.cluster }} in {{ $labels.environment }} is down"
              description: "The Kubernetes API server for cluster {{ $labels.cluster }} in environment {{ $labels.environment }} has been unreachable for more than 5 minutes."
          
          # Cross-environment comparison alerts
          - alert: EnvironmentDrift
            expr: |
              abs(
                avg by (cluster) (node_memory_MemAvailable_bytes{environment="prd"}) -
                avg by (cluster) (node_memory_MemAvailable_bytes{environment="stg"})
              ) > 1e9
            for: 15m
            labels:
              severity: warning
              environment: "{{ $labels.environment }}"
            annotations:
              summary: "Memory usage drift detected between staging and production"
              description: "Memory usage difference between staging and production environments exceeds 1GB"
          
          # GPU utilization across all clusters
          - alert: MultiClusterGPUHigh
            expr: nvidia_gpu_utilization_gpu > 90
            for: 10m
            labels:
              severity: warning
              environment: "{{ $labels.environment }}"
              cluster: "{{ $labels.cluster }}"
            annotations:
              summary: "High GPU utilization in cluster {{ $labels.cluster }}"
              description: "GPU utilization is {{ $value }}% in cluster {{ $labels.cluster }} environment {{ $labels.environment }}"
          
          # Node memory pressure
          - alert: NodeMemoryPressure
            expr: (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) < 0.1
            for: 5m
            labels:
              severity: warning
              environment: "{{ $labels.environment }}"
              cluster: "{{ $labels.cluster }}"
            annotations:
              summary: "High memory pressure on node {{ $labels.instance }}"
              description: "Node {{ $labels.instance }} in cluster {{ $labels.cluster }} has less than 10% available memory"
          
          # Node CPU pressure
          - alert: NodeCPUPressure
            expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
            for: 5m
            labels:
              severity: warning
              environment: "{{ $labels.environment }}"
              cluster: "{{ $labels.cluster }}"
            annotations:
              summary: "High CPU pressure on node {{ $labels.instance }}"
              description: "Node {{ $labels.instance }} in cluster {{ $labels.cluster }} has CPU usage above 80%"
          
          # Pod restart rate
          - alert: HighPodRestartRate
            expr: rate(kube_pod_container_status_restarts_total[15m]) > 0.1
            for: 5m
            labels:
              severity: warning
              environment: "{{ $labels.environment }}"
              cluster: "{{ $labels.cluster }}"
            annotations:
              summary: "High pod restart rate in {{ $labels.namespace }}"
              description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting frequently"
          
          # Persistent volume usage
          - alert: PersistentVolumeUsageHigh
            expr: (kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) > 0.85
            for: 5m
            labels:
              severity: warning
              environment: "{{ $labels.environment }}"
              cluster: "{{ $labels.cluster }}"
            annotations:
              summary: "Persistent volume usage high"
              description: "Persistent volume {{ $labels.persistentvolumeclaim }} is more than 85% full"
          
          # Network connectivity issues
          - alert: NetworkConnectivityIssues
            expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
            for: 5m
            labels:
              severity: warning
              environment: "{{ $labels.environment }}"
              cluster: "{{ $labels.cluster }}"
            annotations:
              summary: "High rate of 5xx errors"
              description: "Service {{ $labels.service }} is returning 5xx errors at a high rate"
          
          # Cross-cluster service dependency
          - alert: CrossClusterServiceDown
            expr: up{job="cross-cluster-service"} == 0
            for: 2m
            labels:
              severity: critical
              environment: "{{ $labels.environment }}"
              cluster: "{{ $labels.cluster }}"
            annotations:
              summary: "Cross-cluster service {{ $labels.service }} is down"
              description: "Service {{ $labels.service }} in cluster {{ $labels.cluster }} is not responding" 