apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: alertmanager
  namespace: observability-alertmanager
spec:
  interval: 5m
  chart:
    spec:
      chart: alertmanager
      version: "0.27.0"
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
  values:
    config:
      global:
        resolve_timeout: 5m
        slack_api_url: 'https://hooks.slack.com/services/YOUR_SLACK_WEBHOOK'
      
      route:
        group_by: ['cluster', 'environment', 'alertname']
        group_wait: 10s
        group_interval: 10s
        repeat_interval: 1h
        receiver: 'default'
        routes:
          - match:
              environment: prd
            receiver: 'production-alerts'
            routes:
              - match:
                  severity: critical
                receiver: 'production-critical'
          
          - match:
              environment: stg
            receiver: 'staging-alerts'
          
          - match:
              environment: dev
            receiver: 'development-alerts'
      
      receivers:
        - name: 'default'
          slack_configs:
            - api_url: 'https://hooks.slack.com/services/YOUR_SLACK_WEBHOOK'
              channel: '#platform-alerts'
              title: 'ALERT: {{ .GroupLabels.cluster }} - {{ .GroupLabels.alertname }}'
              text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
        
        - name: 'production-critical'
          slack_configs:
            - api_url: 'https://hooks.slack.com/services/YOUR_SLACK_WEBHOOK'
              channel: '#prod-critical'
              title: 'ðŸš¨ CRITICAL: {{ .GroupLabels.cluster }} - {{ .GroupLabels.alertname }}'
              text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
        
        - name: 'production-alerts'
          slack_configs:
            - api_url: 'https://hooks.slack.com/services/YOUR_SLACK_WEBHOOK'
              channel: '#prod-alerts'
              title: 'PROD: {{ .GroupLabels.cluster }} - {{ .GroupLabels.alertname }}'
              text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
        
        - name: 'staging-alerts'
          slack_configs:
            - api_url: 'https://hooks.slack.com/services/YOUR_SLACK_WEBHOOK'
              channel: '#staging-alerts'
              title: 'STG: {{ .GroupLabels.cluster }} - {{ .GroupLabels.alertname }}'
              text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
        
        - name: 'development-alerts'
          slack_configs:
            - api_url: 'https://hooks.slack.com/services/YOUR_SLACK_WEBHOOK'
              channel: '#dev-alerts'
              title: 'DEV: {{ .GroupLabels.cluster }} - {{ .GroupLabels.alertname }}'
              text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
      
      inhibit_rules:
        - source_match:
            severity: 'critical'
          target_match:
            severity: 'warning'
          equal: ['alertname', 'cluster', 'environment']
    
    ingress:
      enabled: true
      ingressClassName: nginx-internal
      hosts:
        - name: alertmanager.platform-core.internal
          path: /
          pathType: Prefix
      annotations:
        nginx.ingress.kubernetes.io/proxy-body-size: "0"
    
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi 